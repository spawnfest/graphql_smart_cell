// Copied and pasted with love and admiration from https://raw.githubusercontent.com/livebook-dev/kino_db/8dbbf16b7ba1759374e9b2daac5d8cec8044c47a/LICENSE
//                          Apache License
//                          Version 2.0, January 2004
//                       http://www.apache.org/licenses/

//  TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

//  1. Definitions.

//     "License" shall mean the terms and conditions for use, reproduction,
//     and distribution as defined by Sections 1 through 9 of this document.

//     "Licensor" shall mean the copyright owner or entity authorized by
//     the copyright owner that is granting the License.

//     "Legal Entity" shall mean the union of the acting entity and all
//     other entities that control, are controlled by, or are under common
//     control with that entity. For the purposes of this definition,
//     "control" means (i) the power, direct or indirect, to cause the
//     direction or management of such entity, whether by contract or
//     otherwise, or (ii) ownership of fifty percent (50%) or more of the
//     outstanding shares, or (iii) beneficial ownership of such entity.

//     "You" (or "Your") shall mean an individual or Legal Entity
//     exercising permissions granted by this License.

//     "Source" form shall mean the preferred form for making modifications,
//     including but not limited to software source code, documentation
//     source, and configuration files.

//     "Object" form shall mean any form resulting from mechanical
//     transformation or translation of a Source form, including but
//     not limited to compiled object code, generated documentation,
//     and conversions to other media types.

//     "Work" shall mean the work of authorship, whether in Source or
//     Object form, made available under the License, as indicated by a
//     copyright notice that is included in or attached to the work
//     (an example is provided in the Appendix below).

//     "Derivative Works" shall mean any work, whether in Source or Object
//     form, that is based on (or derived from) the Work and for which the
//     editorial revisions, annotations, elaborations, or other modifications
//     represent, as a whole, an original work of authorship. For the purposes
//     of this License, Derivative Works shall not include works that remain
//     separable from, or merely link (or bind by name) to the interfaces of,
//     the Work and Derivative Works thereof.

//     "Contribution" shall mean any work of authorship, including
//     the original version of the Work and any modifications or additions
//     to that Work or Derivative Works thereof, that is intentionally
//     submitted to Licensor for inclusion in the Work by the copyright owner
//     or by an individual or Legal Entity authorized to submit on behalf of
//     the copyright owner. For the purposes of this definition, "submitted"
//     means any form of electronic, verbal, or written communication sent
//     to the Licensor or its representatives, including but not limited to
//     communication on electronic mailing lists, source code control systems,
//     and issue tracking systems that are managed by, or on behalf of, the
//     Licensor for the purpose of discussing and improving the Work, but
//     excluding communication that is conspicuously marked or otherwise
//     designated in writing by the copyright owner as "Not a Contribution."

//     "Contributor" shall mean Licensor and any individual or Legal Entity
//     on behalf of whom a Contribution has been received by Licensor and
//     subsequently incorporated within the Work.

//  2. Grant of Copyright License. Subject to the terms and conditions of
//     this License, each Contributor hereby grants to You a perpetual,
//     worldwide, non-exclusive, no-charge, royalty-free, irrevocable
//     copyright license to reproduce, prepare Derivative Works of,
//     publicly display, publicly perform, sublicense, and distribute the
//     Work and such Derivative Works in Source or Object form.

//  3. Grant of Patent License. Subject to the terms and conditions of
//     this License, each Contributor hereby grants to You a perpetual,
//     worldwide, non-exclusive, no-charge, royalty-free, irrevocable
//     (except as stated in this section) patent license to make, have made,
//     use, offer to sell, sell, import, and otherwise transfer the Work,
//     where such license applies only to those patent claims licensable
//     by such Contributor that are necessarily infringed by their
//     Contribution(s) alone or by combination of their Contribution(s)
//     with the Work to which such Contribution(s) was submitted. If You
//     institute patent litigation against any entity (including a
//     cross-claim or counterclaim in a lawsuit) alleging that the Work
//     or a Contribution incorporated within the Work constitutes direct
//     or contributory patent infringement, then any patent licenses
//     granted to You under this License for that Work shall terminate
//     as of the date such litigation is filed.

//  4. Redistribution. You may reproduce and distribute copies of the
//     Work or Derivative Works thereof in any medium, with or without
//     modifications, and in Source or Object form, provided that You
//     meet the following conditions:

//     (a) You must give any other recipients of the Work or
//         Derivative Works a copy of this License; and

//     (b) You must cause any modified files to carry prominent notices
//         stating that You changed the files; and

//     (c) You must retain, in the Source form of any Derivative Works
//         that You distribute, all copyright, patent, trademark, and
//         attribution notices from the Source form of the Work,
//         excluding those notices that do not pertain to any part of
//         the Derivative Works; and

//     (d) If the Work includes a "NOTICE" text file as part of its
//         distribution, then any Derivative Works that You distribute must
//         include a readable copy of the attribution notices contained
//         within such NOTICE file, excluding those notices that do not
//         pertain to any part of the Derivative Works, in at least one
//         of the following places: within a NOTICE text file distributed
//         as part of the Derivative Works; within the Source form or
//         documentation, if provided along with the Derivative Works; or,
//         within a display generated by the Derivative Works, if and
//         wherever such third-party notices normally appear. The contents
//         of the NOTICE file are for informational purposes only and
//         do not modify the License. You may add Your own attribution
//         notices within Derivative Works that You distribute, alongside
//         or as an addendum to the NOTICE text from the Work, provided
//         that such additional attribution notices cannot be construed
//         as modifying the License.

//     You may add Your own copyright statement to Your modifications and
//     may provide additional or different license terms and conditions
//     for use, reproduction, or distribution of Your modifications, or
//     for any such Derivative Works as a whole, provided Your use,
//     reproduction, and distribution of the Work otherwise complies with
//     the conditions stated in this License.

//  5. Submission of Contributions. Unless You explicitly state otherwise,
//     any Contribution intentionally submitted for inclusion in the Work
//     by You to the Licensor shall be under the terms and conditions of
//     this License, without any additional terms or conditions.
//     Notwithstanding the above, nothing herein shall supersede or modify
//     the terms of any separate license agreement you may have executed
//     with Licensor regarding such Contributions.

//  6. Trademarks. This License does not grant permission to use the trade
//     names, trademarks, service marks, or product names of the Licensor,
//     except as required for reasonable and customary use in describing the
//     origin of the Work and reproducing the content of the NOTICE file.

//  7. Disclaimer of Warranty. Unless required by applicable law or
//     agreed to in writing, Licensor provides the Work (and each
//     Contributor provides its Contributions) on an "AS IS" BASIS,
//     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
//     implied, including, without limitation, any warranties or conditions
//     of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
//     PARTICULAR PURPOSE. You are solely responsible for determining the
//     appropriateness of using or redistributing the Work and assume any
//     risks associated with Your exercise of permissions under this License.

//  8. Limitation of Liability. In no event and under no legal theory,
//     whether in tort (including negligence), contract, or otherwise,
//     unless required by applicable law (such as deliberate and grossly
//     negligent acts) or agreed to in writing, shall any Contributor be
//     liable to You for damages, including any direct, indirect, special,
//     incidental, or consequential damages of any character arising as a
//     result of this License or out of the use or inability to use the
//     Work (including but not limited to damages for loss of goodwill,
//     work stoppage, computer failure or malfunction, or any and all
//     other commercial damages or losses), even if such Contributor
//     has been advised of the possibility of such damages.

//  9. Accepting Warranty or Additional Liability. While redistributing
//     the Work or Derivative Works thereof, You may choose to offer,
//     and charge a fee for, acceptance of support, warranty, indemnity,
//     or other liability obligations and/or rights consistent with this
//     License. However, in accepting such obligations, You may act only
//     on Your own behalf and on Your sole responsibility, not on behalf
//     of any other Contributor, and only if You agree to indemnify,
//     defend, and hold each Contributor harmless for any liability
//     incurred by, or claims asserted against, such Contributor by reason
//     of your accepting any such warranty or additional liability.

//  END OF TERMS AND CONDITIONS

import * as Vue from "https://cdn.jsdelivr.net/npm/vue@3.2.26/dist/vue.esm-browser.prod.js";

export function init(ctx, info) {
    ctx.importCSS("main.css");
    ctx.importCSS(
        "https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap"
    );

    const BaseSelect = {
        name: "BaseSelect",

        props: {
            label: {
                type: String,
                default: "",
            },
            selectClass: {
                type: String,
                default: "input",
            },
            modelValue: {
                type: String,
                default: "",
            },
            options: {
                type: Array,
                default: [],
                required: true,
            },
            required: {
                type: Boolean,
                default: false,
            },
            inline: {
                type: Boolean,
                default: false,
            },
            grow: {
                type: Boolean,
                default: false,
            },
        },

        methods: {
            available(value, options) {
                return value ?
                    options.map((option) => option.value).includes(value) :
                    true;
            },
        },

        template: `
    <div v-bind:class="[inline ? 'inline-field' : 'field', grow ? 'grow' : '']">
      <label v-bind:class="inline ? 'inline-input-label' : 'input-label'">
        {{ label }}
      </label>
      <select
        :value="modelValue"
        v-bind="$attrs"
        @change="$emit('update:modelValue', $event.target.value)"
        v-bind:class="[selectClass, { unavailable: !available(modelValue, options) }]"
      >
        <option v-if="!required && !available(modelValue, options)"></option>
        <option
          v-for="option in options"
          :value="option.value"
          :key="option"
          :selected="option.value === modelValue"
        >{{ option.label }}</option>
        <option
          v-if="!available(modelValue, options)"
          class="unavailable"
          :value="modelValue"
        >{{ modelValue }}</option>
      </select>
    </div>
    `,
    };

    const BaseInput = {
        name: "BaseInput",

        props: {
            label: {
                type: String,
                default: "",
            },
            inputClass: {
                type: String,
                default: "input",
            },
            modelValue: {
                type: [String, Number],
                default: "",
            },
            inline: {
                type: Boolean,
                default: false,
            },
            grow: {
                type: Boolean,
                default: false,
            },
            number: {
                type: Boolean,
                default: false,
            },
        },

        computed: {
            emptyClass() {
                if (this.modelValue === "") {
                    return "empty";
                }
            },
        },

        template: `
    <div v-bind:class="[inline ? 'inline-field' : 'field', grow ? 'grow' : '']">
      <label v-bind:class="inline ? 'inline-input-label' : 'input-label'">
        {{ label }}
      </label>
      <input
        :value="modelValue"
        @input="$emit('update:modelValue', $event.target.value)"
        v-bind="$attrs"
        v-bind:class="[inputClass, number ? 'input-number' : '', emptyClass]"
      >
    </div>
    `,
    };

    const BaseSwitch = {
        name: "BaseSwitch",

        props: {
            label: {
                type: String,
                default: "",
            },
            modelValue: {
                type: Boolean,
                default: true,
            },
            inline: {
                type: Boolean,
                default: false,
            },
            grow: {
                type: Boolean,
                default: false,
            },
        },

        template: `
    <div v-bind:class="[inline ? 'inline-field' : 'field', grow ? 'grow' : '']">
      <label v-bind:class="inline ? 'inline-input-label' : 'input-label'">
        {{ label }}
      </label>
      <div class="input-container">
        <label class="switch-button">
          <input
            :checked="modelValue"
            type="checkbox"
            @input="$emit('update:modelValue', $event.target.checked)"
            v-bind="$attrs"
            class="switch-button-checkbox"
            v-bind:class="[inputClass, number ? 'input-number' : '']"
          >
          <div class="switch-button-bg" />
        </label>
      </div>
    </div>
    `,
    };

    const BaseSecret = {
        name: "BaseSecret",

        components: {
            BaseInput: BaseInput,
            BaseSelect: BaseSelect,
        },

        props: {
            textInputName: {
                type: String,
                default: "",
            },
            secretInputName: {
                type: String,
                default: "",
            },
            toggleInputName: {
                type: String,
                default: "",
            },
            label: {
                type: String,
                default: "",
            },
            toggleInputValue: {
                type: [String, Number],
                default: "",
            },
            secretInputValue: {
                type: [String, Number],
                default: "",
            },
            textInputValue: {
                type: [String, Number],
                default: "",
            },
            modalTitle: {
                type: String,
                default: "Select secret",
            },
        },

        methods: {
            selectSecret() {
                const preselectName = this.secretInputValue;
                ctx.selectSecret(
                    (secretName) => {
                        ctx.pushEvent("update_field", {
                            field: this.secretInputName,
                            value: secretName,
                        });
                    },
                    preselectName, {
                        title: this.modalTitle
                    }
                );
            },
        },

        template: `
      <div class="input-icon-container grow">
        <BaseInput
          v-if="toggleInputValue"
          :name="secretInputName"
          :label="label"
          :value="secretInputValue"
          inputClass="input input-icon"
          :grow
          readonly
          @click="selectSecret"
          @input="$emit('update:secretInputValue', $event.target.value)"
        />
        <BaseInput
          v-else
          :name="textInputName"
          :label="label"
          type="text"
          :value="textInputValue"
          inputClass="input input-icon-text"
          :grow
          @input="$emit('update:textInputValue', $event.target.value)"
        />
        <div class="icon-container">
          <label class="hidden-checkbox">
            <input
              type="checkbox"
              :name="toggleInputName"
              :checked="toggleInputValue"
              @input="$emit('update:toggleInputValue', $event.target.checked)"
              class="hidden-checkbox-input"
            />
            <svg v-if="toggleInputValue" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                  width="22" height="22">
              <path fill="none" d="M0 0h24v24H0z"/>
              <path d="M18 8h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h2V7a6 6 0 1 1 12 0v1zM5
                10v10h14V10H5zm6 4h2v2h-2v-2zm-4 0h2v2H7v-2zm8 0h2v2h-2v-2zm1-6V7a4 4 0 1 0-8 0v1h8z" fill="#000"/>
            </svg>
            <svg v-else xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
              <path fill="none" d="M0 0h24v24H0z"/>
              <path d="M21 3v18H3V3h18zm-8.001 3h-2L6.6 17h2.154l1.199-3h4.09l1.201 3h2.155l-4.4-11zm-1 2.885L13.244
                12h-2.492l1.247-3.115z" fill="#445668"/>
            </svg>
          </label>
        </div>
      </div>
    `,
    };

    const SQLiteForm = {
        name: "SQLiteForm",

        components: {
            BaseInput: BaseInput,
        },

        props: {
            fields: {
                type: Object,
                default: {},
            },
        },

        template: `
    <div class="row">
      <BaseInput
        name="database_path"
        label="Database Path"
        type="text"
        v-model="fields.database_path"
        inputClass="input"
        :grow
        :required
      />
    </div>
    `,
    };

    const DefaultSQLForm = {
        name: "DefaultSQLForm",

        components: {
            BaseInput: BaseInput,
            BaseSwitch: BaseSwitch,
            BaseSelect: BaseSelect,
            BaseSecret: BaseSecret,
        },

        data() {
            return {
                locked: false,
            };
        },

        props: {
            fields: {
                type: Object,
                default: {},
            },
        },

        template: `
    <div class="row mixed-row">
      <BaseInput
        name="hostname"
        label="Hostname"
        type="text"
        v-model="fields.hostname"
        inputClass="input"
        :grow
        :required
      />
      <BaseInput
        name="port"
        label="Port"
        type="number"
        v-model="fields.port"
        inputClass="input input--xs input--number"
        :grow
        :required
      />
      <BaseSwitch
        name="use_ipv6"
        label="IPv6"
        v-model="fields.use_ipv6"
      />
    </div>
    <div class="row">
      <BaseInput
        name="database"
        label="Database"
        type="text"
        v-model="fields.database"
        inputClass="input"
        :grow
      />
      <BaseInput
        name="username"
        label="User"
        type="text"
        v-model="fields.username"
        inputClass="input"
        :grow
      />
      <BaseSecret
        textInputName="password"
        secretInputName="password_secret"
        toggleInputName="use_password_secret"
        label="Password"
        v-model:textInputValue="fields.password"
        v-model:secretInputValue="fields.password_secret"
        v-model:toggleInputValue="fields.use_password_secret"
        modalTitle="Set password"
      />
    </div>
    `,
    };

    const AthenaForm = {
        name: "AthenaForm",

        components: {
            BaseInput: BaseInput,
            BaseSecret: BaseSecret,
        },

        props: {
            fields: {
                type: Object,
                default: {},
            },
            helpBox: {
                type: String,
                default: "",
            },
            hasAwsCredentials: {
                type: Boolean,
                default: false,
            },
        },

        methods: {
            areFieldsEmpty(currentField, otherField) {
                if (currentField === "" && otherField === "") {
                    return true;
                }

                return false;
            },
        },

        template: `
    <div class="row mixed-row">
      <BaseInput
        name="access_key_id"
        label="Access Key ID"
        type="text"
        v-model="fields.access_key_id"
        inputClass="input"
        :grow
        :required="!hasAwsCredentials"
      />
      <BaseSecret
        textInputName="secret_access_key"
        secretInputName="secret_access_key_secret"
        toggleInputName="use_secret_access_key_secret"
        label="Secret Access Key"
        v-model:textInputValue="fields.secret_access_key"
        v-model:secretInputValue="fields.secret_access_key_secret"
        v-model:toggleInputValue="fields.use_secret_access_key_secret"
        modalTitle="Set secret access key"
      />
    </div>
    <div class="row mixed-row">
      <BaseInput
        name="token"
        label="Session Token"
        type="password"
        v-model="fields.token"
        inputClass="input"
        :grow
      />
      <BaseInput
        name="region"
        label="Region"
        type="text"
        v-model="fields.region"
        inputClass="input"
        :grow
        :required="!hasAwsCredentials"
      />
    </div>
    <div class="row mixed-row">
      <BaseInput
        name="database"
        label="Database"
        type="text"
        v-model="fields.database"
        inputClass="input"
        :grow
        :required
      />
      <BaseInput
        name="workgroup"
        label="Workgroup"
        type="text"
        v-model="fields.workgroup"
        inputClass="input"
        :grow
        :required="!!areFieldsEmpty(fields.workgroup, fields.output_location)"
      />
      <BaseInput
        name="output_location"
        label="Output Location"
        type="url"
        v-model="fields.output_location"
        inputClass="input"
        :grow
        :required="!!areFieldsEmpty(fields.output_location, fields.workgroup)"
      />
    </div>
    <small class="help-box" v-if="hasAwsCredentials" v-html="helpBox" />
    `,
    };

    const BigQueryForm = {
        name: "BigQueryForm",

        components: {
            BaseInput: BaseInput,
        },

        props: {
            fields: {
                type: Object,
                default: {},
            },
            helpBox: {
                type: String,
                default: "",
            },
        },

        methods: {
            credentialsChange(_) {
                this.updateCredentials(this.$refs.credentials.files);
            },

            credentialsClick(_) {
                this.$refs.credentials.click();
            },

            dragOver(event) {
                event.preventDefault();
            },

            dragLeave(_) {},

            drop(event) {
                event.preventDefault();
                this.updateCredentials(event.dataTransfer.files);
            },

            updateCredentials(fileList) {
                const file = fileList[0];

                if (file && file.type === "application/json") {
                    const reader = new FileReader();

                    reader.onload = (res) => {
                        const value = JSON.parse(res.target.result);
                        ctx.pushEvent("update_field", {
                            field: "credentials",
                            value
                        });
                    };

                    reader.readAsText(file);
                }
            },
        },

        template: `
    <div class="row mixed-row">
      <BaseInput
        name="project_id"
        label="Project ID"
        type="text"
        v-model="fields.project_id"
        inputClass="input"
        :grow
        :required
      />
      <BaseInput
        name="default_dataset_id"
        label="Default Dataset ID (Optional)"
        type="text"
        v-model="fields.default_dataset_id"
        inputClass="input"
        :grow
      />
    </div>
    <div class="row">
      <div class="draggable" @dragover="dragOver" @dragleave="dragLeave" @drop="drop" @click="credentialsClick">
        <label for="credentials">
          Drag your credentials JSON file here<br/>
          or click here to select your file.
        </label>
        <input type="file" ref="credentials" @change="credentialsChange" />
      </div>
    </div>
    <small class="help-box" v-html="helpBox" />
    `,
    };

    const app = Vue.createApp({
        components: {
            BaseInput: BaseInput,
            BaseSelect: BaseSelect,
            SQLiteForm: SQLiteForm,
            DefaultSQLForm: DefaultSQLForm,
            BigQueryForm: BigQueryForm,
            AthenaForm: AthenaForm,
        },

        template: `
    <div class="app">
      <!-- Info Messages -->
      <div id="info-box" class="info-box" v-if="missingDep">
        <p>To successfully connect, you need to add the following dependency:</p>
        <span>{{ missingDep }}</span>
      </div>
      <form @change="handleFieldChange">
        <div class="container">
          <div class="row header">
            <BaseInput
              name="url"
              label=" API URL"
              v-model="fields.url"
              selectClass="input input--xs input-text"
              :inline
            />

            <BaseInput
              name="variable"
              label=" Assign to "
              type="text"
              v-model="fields.variable"
              inputClass="input input--xs input-text"
              :inline
            />
          </div>
        </div>
      </form>
    </div>
    `,

        data() {
            return {
                fields: info.fields,
                missingDep: info.missing_dep,
                helpBox: info.help_box,
                hasAwsCredentials: info.has_aws_credentials,
                availableDatabases: [{
                        label: "PostgreSQL",
                        value: "postgres"
                    },
                    {
                        label: "MySQL",
                        value: "mysql"
                    },
                    {
                        label: "SQLite",
                        value: "sqlite"
                    },
                    {
                        label: "Google BigQuery",
                        value: "bigquery"
                    },
                    {
                        label: "AWS Athena",
                        value: "athena"
                    },
                ],
            };
        },

        computed: {
            isSQLite() {
                return this.fields.type === "sqlite";
            },

            isBigQuery() {
                return this.fields.type === "bigquery";
            },

            isAthena() {
                return this.fields.type === "athena";
            },

            isDefaultDatabase() {
                return ["postgres", "mysql"].includes(this.fields.type);
            },
        },

        methods: {
            handleFieldChange(event) {
                const field = event.target.name;
                if (field) {
                    const value = this.fields[field];
                    ctx.pushEvent("update_field", {
                        field,
                        value
                    });
                }
            },
        },
    }).mount(ctx.root);

    ctx.handleEvent("update", ({
        fields
    }) => {
        setValues(fields);
    });

    ctx.handleEvent("missing_dep", ({
        dep
    }) => {
        app.missingDep = dep;
    });

    ctx.handleSync(() => {
        // Synchronously invokes change listeners
        document.activeElement &&
            document.activeElement.dispatchEvent(
                new Event("change", {
                    bubbles: true
                })
            );
    });

    function setValues(fields) {
        for (const field in fields) {
            app.fields[field] = fields[field];
        }
    }
}

/*
Logs a named, collapsed group in the console.
*/
function log(name, data) {
    console.groupCollapsed(name);
    console.log(data);
    console.groupEnd();
}